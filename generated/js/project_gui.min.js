function update(){ctx.clearRect(0,0,canvas.width,canvas.height),cloth.update(),cloth.draw(),requestAnimFrame(update)}function start(){canvas.onmousedown=function(a){mouse.button=a.which,mouse.px=mouse.x,mouse.py=mouse.y;var b=canvas.getBoundingClientRect();mouse.x=a.clientX-b.left,mouse.y=a.clientY-b.top,mouse.down=!0,a.preventDefault()},canvas.onmouseup=function(a){mouse.down=!1,a.preventDefault()},canvas.onmousemove=function(a){mouse.px=mouse.x,mouse.py=mouse.y;var b=canvas.getBoundingClientRect();mouse.x=a.clientX-b.left,mouse.y=a.clientY-b.top,a.preventDefault()},canvas.oncontextmenu=function(a){a.preventDefault()},boundsx=canvas.width-1,boundsy=canvas.height-1,ctx.strokeStyle="#888",cloth=new Cloth,update()}var physics_accuracy=3,mouse_influence=20,mouse_cut=5,gravity=1200,cloth_height=30,cloth_width=50,start_y=20,spacing=7,tear_distance=60;window.requestAnimFrame=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(a){window.setTimeout(a,1e3/60)};var canvas,ctx,cloth,boundsx,boundsy,mouse={down:!1,button:1,x:0,y:0,px:0,py:0},Point=function(a,b){this.x=a,this.y=b,this.px=a,this.py=b,this.vx=0,this.vy=0,this.pin_x=null,this.pin_y=null,this.constraints=[]};Point.prototype.update=function(a){if(mouse.down){var b=this.x-mouse.x,c=this.y-mouse.y,d=Math.sqrt(b*b+c*c);1==mouse.button?mouse_influence>d&&(this.px=this.x-1.8*(mouse.x-mouse.px),this.py=this.y-1.8*(mouse.y-mouse.py)):mouse_cut>d&&(this.constraints=[])}this.add_force(0,gravity),a*=a,nx=this.x+.99*(this.x-this.px)+this.vx/2*a,ny=this.y+.99*(this.y-this.py)+this.vy/2*a,this.px=this.x,this.py=this.y,this.x=nx,this.y=ny,this.vy=this.vx=0},Point.prototype.draw=function(){if(!(this.constraints.length<=0))for(var a=this.constraints.length;a--;)this.constraints[a].draw()},Point.prototype.resolve_constraints=function(){if(null!=this.pin_x&&null!=this.pin_y)return this.x=this.pin_x,void(this.y=this.pin_y);for(var a=this.constraints.length;a--;)this.constraints[a].resolve();this.x>boundsx?this.x=2*boundsx-this.x:this.x<1&&(this.x=2-this.x),this.y>boundsy?this.y=2*boundsy-this.y:this.y<1&&(this.y=2-this.y)},Point.prototype.attach=function(a){this.constraints.push(new Constraint(this,a))},Point.prototype.remove_constraint=function(a){for(var b=this.constraints.length;b--;)this.constraints[b]==a&&this.constraints.splice(b,1)},Point.prototype.add_force=function(a,b){this.vx+=a,this.vy+=b},Point.prototype.pin=function(a,b){this.pin_x=a,this.pin_y=b};var Constraint=function(a,b){this.p1=a,this.p2=b,this.length=spacing};Constraint.prototype.resolve=function(){var a=this.p1.x-this.p2.x,b=this.p1.y-this.p2.y,c=Math.sqrt(a*a+b*b),d=(this.length-c)/c;c>tear_distance&&this.p1.remove_constraint(this);var e=a*d*.5,f=b*d*.5;this.p1.x+=e,this.p1.y+=f,this.p2.x-=e,this.p2.y-=f},Constraint.prototype.draw=function(){ctx.moveTo(this.p1.x,this.p1.y),ctx.lineTo(this.p2.x,this.p2.y)};var Cloth=function(){this.points=[];for(var a=canvas.width/2-cloth_width*spacing/2,b=0;cloth_height>=b;b++)for(var c=0;cloth_width>=c;c++){var d=new Point(a+c*spacing,start_y+b*spacing);0!=c&&d.attach(this.points[this.points.length-1]),0==b&&d.pin(d.x,d.y),0!=b&&d.attach(this.points[c+(b-1)*(cloth_width+1)]),this.points.push(d)}};Cloth.prototype.update=function(){for(var a=physics_accuracy;a--;)for(var b=this.points.length;b--;)this.points[b].resolve_constraints();for(a=this.points.length;a--;)this.points[a].update(.016)},Cloth.prototype.draw=function(){ctx.beginPath();for(var a=cloth.points.length;a--;)cloth.points[a].draw();ctx.stroke()},window.onload=function(){canvas=document.getElementById("c"),ctx=canvas.getContext("2d"),canvas.width=560,canvas.height=350,start()};